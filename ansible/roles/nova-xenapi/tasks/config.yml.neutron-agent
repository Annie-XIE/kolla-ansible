---
- name: Prepare HIMN script
  copy:
    src: /root/xenapi/prepareHIMN.sh
    dest: /usr/bin/prepareHIMN
    owner: root
    group: root
    mode: 0755
- name: execute HIMN script
  script: /usr/bin/prepareHIMN

- name: Copying over neutron.conf
  vars:
    service_name: "{{ item.key }}"
    services_need_neutron_conf:
      - "neutron-openvswitch-agent-domua"
  merge_configs:
    sources:
      - "{{ role_path }}/../neutron/templates/neutron.conf.j2"
      - "{{ node_custom_config }}/global.conf"
      - "{{ node_custom_config }}/database.conf"
      - "{{ node_custom_config }}/messaging.conf"
      - "{{ node_custom_config }}/neutron.conf"
      - "{{ node_custom_config }}/neutron/{{ item.key }}.conf"
      - "{{ node_custom_config }}/neutron/{{ inventory_hostname }}/neutron.conf"
    dest: "{{ node_config_directory }}/{{ item.key }}/neutron.conf"
  register: neutron_confs
  when:
    - item.key in services_need_neutron_conf
  with_dict: "{{ neutron_services }}"
  notify:
    - "Restart {{ item.key }} container"

- name: Copying over ml2_conf_domua.ini
  vars:
    service_name: "{{ item.key }}"
    services_need_ml2_conf_domua_ini:
      - "neutron-openvswitch-agent-domua"
  merge_configs:
    sources:
      - "{{ role_path }}/templates/ml2_domua_conf.ini.j2"
      - "{{ node_custom_config }}/neutron/ml2_conf_domua.ini"
      - "{{ node_custom_config }}/neutron/{{ inventory_hostname }}/ml2_conf_domua.ini"
    dest: "{{ node_config_directory }}/{{ service_name }}/ml2_conf_domua.ini"
  register: neutron_ml2_domua_confs
  when:
    - item.key in services_need_ml2_conf_domua_ini
  with_dict: "{{ neutron_services }}"
  notify:
    - "Restart {{ item.key }} container"

- name: Copying over config.json files for neutron domu agent
  template:
    src: "{{ item.key }}.json.j2"
    dest: "{{ node_config_directory }}/{{ item.key }}/config.json"
  register: neutron_config_jsons
  with_items:
    - neutron-openvswitch-agent-domua
  notify:
    - "Restart {{ item.key }} container"
